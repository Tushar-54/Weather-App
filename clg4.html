#include <WiFi.h>
    #include <PubSubClient.h>
    #include <DHT.h>
    
    // WiFi credentials
    const char* ssid = "Your_WiFi_Name";
    const char* password = "Your_WiFi_Password";
    
    // ThingsBoard credentials
    const char* mqtt_server = "demo.thingsboard.io";
    const char* token = "Your_ThingsBoard_Token";
    
    WiFiClient espClient;
    PubSubClient client(espClient);
    
    // DHT11 Setup
    #define DHTPIN 5
    #define DHTTYPE DHT11
    DHT dht(DHTPIN, DHTTYPE);
    
    // Actuator pins
    #define FAN_PIN 13
    #define PUMP_PIN 12
    #define LED_PIN 14
    
    // Sensor pins
    #define SOIL_PIN 34
    #define LIGHT_PIN 35
    #define AIR_PIN 32
    
    bool fanState = false;
    bool pumpState = false;
    bool ledState = false;
    
    // RPC Callback
    void callback(char* topic, byte* payload, unsigned int length) {
      payload[length] = '\0';
      String data = String((char*)payload);
      Serial.println("RPC Payload: " + data);
    
      if (data.indexOf("fan") != -1) {
        fanState = data.indexOf("true") != -1;
        digitalWrite(FAN_PIN, fanState ? HIGH : LOW);
      }
      if (data.indexOf("pump") != -1) {
        pumpState = data.indexOf("true") != -1;
        digitalWrite(PUMP_PIN, pumpState ? HIGH : LOW);
      }
      if (data.indexOf("led") != -1) {
        ledState = data.indexOf("true") != -1;
        digitalWrite(LED_PIN, ledState ? HIGH : LOW);
      }
    }
    
    void setup() {
      Serial.begin(115200);
      dht.begin();
    
      pinMode(FAN_PIN, OUTPUT);
      pinMode(PUMP_PIN, OUTPUT);
      pinMode(LED_PIN, OUTPUT);
    
      WiFi.begin(ssid, password);
      while (WiFi.status() != WL_CONNECTED) {
        delay(1000);
        Serial.println("Connecting to WiFi...");
      }
      Serial.println("Connected to WiFi!");
    
      client.setServer(mqtt_server, 1883);
      client.setCallback(callback);
    }
    
    void reconnect() {
      while (!client.connected()) {
        Serial.print("Connecting to MQTT... ");
        if (client.connect("ESP32Client", token, NULL)) {
          Serial.println("Connected to ThingsBoard!");
          client.subscribe("v1/devices/me/rpc/request/+");
        } else {
          Serial.print("Failed. Retrying in 5s...");
          delay(5000);
        }
      }
    }
    
    void loop() {
      if (!client.connected()) {
        reconnect();
      }
      client.loop();
    
      float temperature = dht.readTemperature();
      float humidity = dht.readHumidity();
      int soilMoisture = analogRead(SOIL_PIN) / 10.23; // % scale
      int lightLevel = analogRead(LIGHT_PIN) / 10.23;  // % scale
      int airQuality = analogRead(AIR_PIN);            // Raw MQ135 value
    
      Serial.printf("T: %.2f | H: %.2f | Soil: %d%% | Light: %d%% | AirQ: %d\n", 
        temperature, humidity, soilMoisture, lightLevel, airQuality);
    
      String payload = "{";
      payload += "\"temperature\":" + String(temperature) + ",";
      payload += "\"humidity\":" + String(humidity) + ",";
      payload += "\"soilMoisture\":" + String(soilMoisture) + ",";
      payload += "\"lightIntensity\":" + String(lightLevel) + ",";
      payload += "\"airQuality\":" + String(airQuality) + ",";
      payload += "\"fan\":" + String(fanState ? 1 : 0) + ",";
      payload += "\"pump\":" + String(pumpState ? 1 : 0) + ",";
      payload += "\"led\":" + String(ledState ? 1 : 0);
      payload += "}";
    
      client.publish("v1/devices/me/telemetry", payload.c_str());
      delay(5000);
    }